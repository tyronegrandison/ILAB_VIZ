<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<title>Untitled Document</title>
<link rel="stylesheet" type="text/css" href="styles/normalize.css" media="all">
<link rel="stylesheet" type="text/css" href="styles/themes.css" media="all">
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="scripts/topojson.min.js"></script>
<script src="scripts/datamaps.world.min.js"></script>
<script type="text/javascript">
	d3.json("data/countries2013.json", function(error, countries2013) {
		//creates an object with the iso2 country name and an array with the Advancement Level and the "number" which is a placeholder for Goods
		var countryData = {};
		var getCountryData = function(countries2013) {
			for (var country in countries2013) {
				var countries = countries2013[country];
				country = countries.ISO3;
				countryData[country] = {};
				if (countries.Advancement_Level && countries.Advancement_Level != '') {
					// get the fillKey value for each country to change it's color based on the advancement level
					countryData[country].fillKey = countries.Advancement_Level;

					// get the advancement level for each country
					countryData[country].advancementLevel = countries.Advancement_Level;
				}

				// get the name of each country to display on hover
				countryData[country].name = countries.Country;

				// for each country, get the number of goods produced by child labor
				function getGoods(countries) {
					// if the country reported goods produced and it's value is not undefined
					if (countryData[country].Goods && typeof countryData[country].Goods[0] !== 'undefined') {
						// get the goods array
						countryData[country].goods = countries.Goods;
						// for (var j=0; j < countryData[countryKey].goods.length; j++) {
						// 	console.log(countryKey + ', ' + countryData[countryKey].goods[j].Good_Name);
						// }
						}
					};
					getGoods(countries);
				}
		    return countryData;
		};
		getCountryData(countries2013);


		// sets up the map
		var basic = new Datamap({
		  element: document.getElementById("basic"),
		  projection: 'mercator', //type of map
		  responsive: true,
		  fills: { // colors used to highlight countries based on their advancement level
				'Significant Advancement': '#ABDDA4',
				'Moderate Advancement': '#c8dda4',
				'Minimal Advancement': '#ECE671',
				'No Advancement': '#DC9595',
				'No Assessment': '#DDDDDD',
				defaultFill: '#DDDDDD'
		  },
		  data: countryData, // set the map's data to our data object
		  geographyConfig: {
				popupTemplate: function(data) {
					var countrySelected = data.id;  // get the data.id for the country hovered over
					var selectedKey = '';

					// for each country in our data object, find the key
					Object.keys(countryData).forEach(function(key) {
						// if the key equals the country hovered over
						if (key === countrySelected) {
							selectedKey = key;
						}
					});

					// if selectedKey is not null, display the country's data on hover
					if (selectedKey !== '') {
						 return '<div class="hoverinfo"><strong>' + countryData[selectedKey].name + '<br />Advancement Level: ' + countryData[selectedKey].advancementLevel + '<br />Number of Goods: ' + countryData[selectedKey].goods + '</strong></div>';
					} else {
					// otherwise, display the country's name and indicate that it has no assessment
						return '<div class="hoverinfo"><strong>' + data.properties.name + '<br />No Assessment' + '</strong></div>';
					}
				}
		  	}
		});

		// display the legend
		basic.legend();

		// resizes the map as the window is resized
		d3.select(window).on('resize', function() {
			basic.resize();
		});
	});


</script>
</head>
<body>
	<header>
		<h1>Visualizing Forced Labor and Child Labor</h1> <!-- Working title -->
	</header>
	<div id="map">
		<div id="basic"></div>
	</div>
	<footer>
		<p><small>Data from the <a href="http://www.dol.gov">Department of Labor's</a> <a href="http://www.dol.gov/ilab/">Bureau of International Labor Affairs (ILAB)</a>    <a href="../data/countries2013.json">Download This Data</a><small></p> <!-- Basic requirement part, can be moved -->
	</footer>
</body>
</html>
